<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src\computation\index.js - muskepeer-client</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="muskepeer-client"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/Computation.html">Computation</a></li>
            
                <li><a href="../classes/Crypto.html">Crypto</a></li>
            
                <li><a href="../classes/Database.html">Database</a></li>
            
                <li><a href="../classes/FileSystem.html">FileSystem</a></li>
            
                <li><a href="../classes/GeoLocation.html">GeoLocation</a></li>
            
                <li><a href="../classes/Job.html">Job</a></li>
            
                <li><a href="../classes/Jobs.html">Jobs</a></li>
            
                <li><a href="../classes/Logger.html">Logger</a></li>
            
                <li><a href="../classes/Mediator.html">Mediator</a></li>
            
                <li><a href="../classes/MuskepeerClient.html">MuskepeerClient</a></li>
            
                <li><a href="../classes/MuskepeerModule.html">MuskepeerModule</a></li>
            
                <li><a href="../classes/Network.html">Network</a></li>
            
                <li><a href="../classes/Node.html">Node</a></li>
            
                <li><a href="../classes/Nodes.html">Nodes</a></li>
            
                <li><a href="../classes/Peer.html">Peer</a></li>
            
                <li><a href="../classes/Peers.html">Peers</a></li>
            
                <li><a href="../classes/Pool.html">Pool</a></li>
            
                <li><a href="../classes/Project.html">Project</a></li>
            
                <li><a href="../classes/Result.html">Result</a></li>
            
                <li><a href="../classes/Results.html">Results</a></li>
            
                <li><a href="../classes/Service.html">Service</a></li>
            
                <li><a href="../classes/Settings.html">Settings</a></li>
            
                <li><a href="../classes/Storage.html">Storage</a></li>
            
                <li><a href="../classes/Uuid.html">Uuid</a></li>
            
                <li><a href="../classes/Worker.html">Worker</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/Computation.html">Computation</a></li>
            
                <li><a href="../modules/Crypto.html">Crypto</a></li>
            
                <li><a href="../modules/Database.html">Database</a></li>
            
                <li><a href="../modules/FileSystem.html">FileSystem</a></li>
            
                <li><a href="../modules/GeoLocation.html">GeoLocation</a></li>
            
                <li><a href="../modules/Jobs.html">Jobs</a></li>
            
                <li><a href="../modules/Logger.html">Logger</a></li>
            
                <li><a href="../modules/Mediator.html">Mediator</a></li>
            
                <li><a href="../modules/MuskepeerClient.html">MuskepeerClient</a></li>
            
                <li><a href="../modules/Network.html">Network</a></li>
            
                <li><a href="../modules/Pool.html">Pool</a></li>
            
                <li><a href="../modules/Project.html">Project</a></li>
            
                <li><a href="../modules/Results.html">Results</a></li>
            
                <li><a href="../modules/Settings.html">Settings</a></li>
            
                <li><a href="../modules/Storage.html">Storage</a></li>
            
                <li><a href="../modules/Uuid.html">Uuid</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: src\computation\index.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 *
 * @module Computation
 * @class Computation
 * @extends MuskepeerModule
 */

define([&#x27;q&#x27;, &#x27;muskepeer-module&#x27;, &#x27;storage/index&#x27;, &#x27;settings&#x27;, &#x27;project&#x27;, &#x27;crypto/index&#x27;, &#x27;./collection/jobs&#x27;, &#x27;./collection/results&#x27;, &#x27;./model/pool&#x27;, &#x27;./model/job&#x27;, &#x27;./model/result&#x27;],


    function (Q, MuskepeerModule, storage, settings, project, crypto, jobs, results, Pool, Job, Result) {

        var module = new MuskepeerModule(),
            countTimer,
            resultCountTimer,
            jobCountTimer;


        /**
         * @private
         * @method allFound
         * @param type
         * @param expected
         * @return {Promise}
         */
        function allFound(type, expected) {

            return storage.db.count(type)
                .then(function (amount) {
                    var deferred = Q.defer();

                    logger.log(&#x27;Computation&#x27;, amount, type);

                    // Update the size
                    if (type === &#x27;results&#x27;) results.size = amount;
                    else jobs.size = amount;

                    // We don&#x27;t know how much to expect, so we can&#x27;t say
                    if (!expected || expected &lt; 0 || !_.isFinite(expected)) {
                        deferred.resolve(false);
                    }

                    // We already have all found?
                    else if (amount &gt;= expected) {
                        // Need to check validity?
                        if (type === &#x27;results&#x27; &amp;&amp; project.computation.results.validation.enabled) {

                            results.allValid()
                                .then(function (answer) {
                                    if (answer) {
                                        logger.log(&#x27;Computation&#x27;, &#x27;All results are valid!&#x27;);
                                    }
                                    else {
                                        logger.log(&#x27;Computation&#x27;, &#x27;Results are not all valid!&#x27;);
                                    }
                                    deferred.resolve(answer);
                                });
                        }
                        else {
                            logger.log(&#x27;Computation&#x27;, &#x27;All&#x27;, type, &#x27;found!&#x27;);
                            deferred.resolve(true);
                        }
                    }
                    else {
                        deferred.resolve(false);
                    }

                    return deferred.promise;

                }

            );
        }


        /**
         * @private
         * @method createThreadPool
         *
         * @param type
         * @param url
         * @return {Promise}
         */
        function createThreadPool(type, url) {

            var expected = project.computation.jobs.expected,
                storeName = &#x27;jobs&#x27;;

            if (type === module.WORKER) {
                expected = project.computation.results.expected;
                storeName = &#x27;results&#x27;;
            }

            return allFound(storeName, expected)
                .then(function (isComplete) {

                    // No need to create a pool if it&#x27;s already complete
                    if (isComplete) {
                        logger.log(&#x27;Computation&#x27;, &#x27;Already finished, not creating a &#x27; + type + &#x27;Pool!&#x27;);
                        return Q();
                    }
                    else {
                        // Get the cached script from local fileSystem
                        return storage.fs.getFileInfoByUri(url)
                            .then(function (fileInfos) {
                                return storage.fs.readFileAsObjectUrl(fileInfos[0]);
                            })
                            .then(function (objectURL) {

                                var amount = 1;

                                if (type === module.WORKER) {

                                    if (project.computation.workers.multipleAllowed) {
                                        amount = settings.maxWorkers;
                                    }

                                    module.workers = new Pool(module.WORKER, objectURL, amount);
                                }
                                else {

                                    if (project.computation.factories.multipleAllowed) {
                                        amount = settings.maxFactories;
                                    }

                                    module.factories = new Pool(module.FACTORY, objectURL, amount);
                                }

                            });

                    }
                });

        }


        /**
         * Create worker instances
         *
         * @private
         * @method createWorkers
         * @return {Promise}
         */
        function createWorkers() {

            // No need for Workers
            if (!project.computation.workers.enabled) {
                logger.log(&#x27;Computation&#x27;, &#x27;Not using Workers&#x27;);
                return Q();
            }
            // Already initiated?
            else if (module.workers) {
                return Q();
            }

            // Instantiate workers
            else {
                logger.log(&#x27;Computation&#x27;, &#x27;Creating Workers&#x27;);

                return createThreadPool(module.WORKER, project.computation.workers.url)
                    .then(function () {
                        if (module.workers) addEventListenersToPool(module.workers);
                    })
            }

        }


        /**
         * Create jobFactory
         *
         * @private
         * @method createFactories
         * @return {Promise}
         */
        function createFactories() {

            // No need for Workers
            if (!project.computation.factories.enabled) {
                logger.log(&#x27;Computation&#x27;, &#x27;Not using Factories&#x27;);
                return Q();
            }
            // Already initiated?
            else if (module.factories) {
                return Q();
            }

            // Instantiate workers
            else {

                return createThreadPool(module.FACTORY, project.computation.factories.url)
                    .then(function () {
                        if (module.factories)  addEventListenersToPool(module.factories);
                    })
            }

        }


        /**
         * @private
         * @method addEventListenersToPool
         */
        function addEventListenersToPool(pool) {
            pool.on(&#x27;result:push&#x27;, poolResultFoundHandler);
            pool.on(&#x27;result:pull&#x27;, poolResultRequiredHandler);

            pool.on(&#x27;job:push&#x27;, poolJobFoundHandler);
            pool.on(&#x27;job:pull&#x27;, poolJobRequiredHandler);

            pool.on(&#x27;file:push&#x27;, poolFileFoundHandler);
            pool.on(&#x27;file:pull&#x27;, poolFileRequiredHandler);

        }

        /**
         * @private
         * @method removeEventListenersFromPool
         */
        function removeEventListenersFromPool(pool) {
            pool.removeAllListeners();
        }

        /**
         * Event-Listener, listens for
         * job:push from Thread-Pool
         *
         * @private
         * @method poolJobFoundHandler
         */
        function poolJobFoundHandler(e) {

            var job = new Job(e.data);

            // Add job to queue (if redundant it will be ignored)
            jobs.add(job).then(function (isNew) {
                if (isNew) {
                    logger.log(&#x27;Thread (&#x27; + e.target.type + &#x27; &#x27; + e.target.id + &#x27;)&#x27;, &#x27;found a new job&#x27;);
                    module.emit(&#x27;job:push&#x27;, job);

                    // Throw the job in the pool
                    module.pushJobToAwaitingWorker(job);
                }
            });

        }


        /**
         * Event-Listener, listens for
         * job:pull from Thread-Pool
         *
         * @private
         * @method poolJobRequiredHandler
         */
        function poolJobRequiredHandler(e) {

            // Specific job?
            if (e.data &amp;&amp; e.data.uuid) {

                logger.log(&#x27;Thread (&#x27; + e.target.type + &#x27; &#x27; + e.target.id + &#x27;)&#x27;, &#x27;needs a specific job&#x27;);

                jobs.getJobByUuid(e.data.uuid).then(function (job) {
                    if (job) {
                        e.target.pushJob(job);
                    }
                });
            }
            // Use next job in queue
            else {

                logger.log(&#x27;Thread (&#x27; + e.target.type + &#x27; &#x27; + e.target.id + &#x27;)&#x27;, &#x27;needs a job&#x27;);

                jobs.getNextAvailableJob()
                    .then(function (job) {

                        if (!job) {
                            logger.log(&#x27;Computation&#x27;, &#x27;No more jobs left!&#x27;);
                            // Mark the thread as idle
                            e.target.isIdle = true;
                            return;
                        }

                        //Lock job
                        jobs.lockJob(job)
                            .then(function () {

                                // Need to publish lock?
                                if (project.computation.jobs.lock) {
                                    module.emit(&#x27;job:lock&#x27;, {uuid: job.uuid})
                                }

                                e.target.pushJob(job);
                            });

                    }
                );
            }
        }


        /**
         * Event-Listener, listens for
         * result:push from Thread-Pool
         *
         * @private
         * @method poolResultFoundHandler
         */
        function poolResultFoundHandler(e) {

            var result = new Result(e.data),
                promise = Q();

            // Using Jobs-Locking?
            if (project.computation.jobs.lock &amp;&amp; result.jobUuid) {
                // Unlock the job
                promise = jobs.unlockJob({uuid: result.jobUuid})
                    .then(function () {
                        module.emit(&#x27;job:unlock&#x27;, {uuid: result.jobUuid});
                    });
            }

            return promise
                .then(function () {
                    return results.add(result)
                })
                .then(function (hasChanged) {

                    if (hasChanged) {

                        logger.log(&#x27;Thread (&#x27; + e.target.type + &#x27; &#x27; + e.target.id + &#x27;)&#x27;, &#x27;found a new result&#x27;);

                        // Inform about new or changed result
                        module.emit(&#x27;result:push&#x27;, result);

                        // What about the job?
                        if (project.computation.factories.enabled &amp;&amp; result.jobUuid) {

                            if (results.isValid(result)) {
                                return jobs.markJobAsComplete({uuid: result.jobUuid})
                                    .then(function () {
                                        module.emit(&#x27;job:push&#x27;, {job: jobs.getJobByUuid(result.jobUuid)});
                                    });
                            }
                        }
                    }
                });
        }


        /**
         * Event-Listener, listens for
         * result:pull from Thread-Pool
         *
         * @private
         * @method poolResultRequiredHandler
         */
        function poolResultRequiredHandler(e) {

            if (!e.data.uuid) return;

            logger.log(&#x27;Thread (&#x27; + e.target.type + &#x27; &#x27; + e.target.id + &#x27;)&#x27;, &#x27;needs a specific result&#x27;);

            // Get result from storage
            storage.db.read(&#x27;results&#x27;, e.data.uuid)
                .then(function (result) {
                    e.target.pushResult(result);
                });

        }


        /**
         * Event-Listener, listens for
         * file:push from Thread-Pool
         *
         * @private
         * @method poolFileFoundHandler
         */
        function poolFileFoundHandler(e) {
            //TODO pass a url or name, actually name would be better
            logger.log(&#x27;Thread (&#x27; + e.target.type + &#x27; &#x27; + e.target.id + &#x27;)&#x27;, &#x27;found a file&#x27;);
        }

        /**
         * Event-Listener, listens for
         * file:pull from Thread-Pool
         *
         * @private
         * @method poolFileRequiredHandler
         */
        function poolFileRequiredHandler(e) {

            var promise,
                fileInfo;

            if (!e.data || ( !e.data.url &amp;&amp; !e.data.name )) {
                return;
            }

            // Get file by url
            if (e.data.url) {
                logger.log(&#x27;Thread (&#x27; + e.target.type + &#x27; &#x27; + e.target.id + &#x27;)&#x27;, &#x27;needs a specific file (gave url)&#x27;);
                promise = storage.fs.getFileInfoByUri(e.data.url);

            }
            // Get file by name
            else if (e.data.name) {
                logger.log(&#x27;Thread (&#x27; + e.target.type + &#x27; &#x27; + e.target.id + &#x27;)&#x27;, &#x27;needs a specific file (gave name: &#x27; + e.data.name + &#x27;)&#x27;);
                promise = storage.fs.getFileInfoByName(e.data.name);
            }

            promise
                .then(function (info) {
                    fileInfo = info[0];

                    var offset = e.data.offset || 0,
                        completeFile = offset === 0;

                    switch (e.data.type) {
                        case &#x27;path&#x27; :
                            return project.uuid + &#x27;/&#x27; + fileInfo.uuid;
                            break;
                        case &#x27;blob&#x27; :
                            return storage.fs.readFileChunkAsBlob(fileInfo, offset, completeFile);
                            break;
                        case &#x27;dataUrl&#x27; :
                            return storage.fs.readFileChunkAsDataUrl(fileInfo, offset, completeFile);
                            break;
                        case &#x27;localUrl&#x27; :
                            return storage.fs.readFileAsLocalUrl(fileInfo);
                            break;
                        default :
                        case &#x27;arrayBuffer&#x27; :
                            return storage.fs.readFileChunkAsArrayBuffer(fileInfo, offset, completeFile);
                            break;
                    }

                }).then(function (file) {

                    // Transfer as transferable Object
                    if (e.data.type === &#x27;arrayBuffer&#x27;) {
                        e.target.pushFileAsTransferableObject(fileInfo, file)
                    }
                    // Transfer as clone (can get expensive!)
                    else {
                        e.target.pushFileAsClone(fileInfo, file)
                    }

                })


        }


        /**
         * @private
         * @method resultCounterCompleteHandler
         * @param e
         */
        function resultCounterCompleteHandler(e) {

            return allFound(&#x27;results&#x27;, project.computation.results.expected)
                .then(function (isComplete) {
                    if (isComplete) module.stopWorkers();
                });
        }

        /**
         * @private
         * @method jobCounterCompleteHandler
         * @param e
         */
        function jobCounterCompleteHandler(e) {
            return allFound(&#x27;jobs&#x27;, project.computation.jobs.expected)
                .then(function (isComplete) {
                    if (isComplete) module.stopFactories();
                });
        }


        /**
         * @private
         * @method counterCompleteHandler
         * @param e
         */
        function counterCompleteHandler(e) {
            return module.isComplete()
                .then(function (isComplete) {
                    if (isComplete) module.stop();
                });
        }


        return module.extend({

            /**
             * @property {Boolean} isRunning
             * @default false
             */
            isRunning: false,
            /**
             * @property {Boolean} isPaused
             * @default false
             */
            isPaused: false,

            /**
             * @property {Object} jobs
             */
            jobs: jobs,

            /**
             * @property {Object} results
             */
            results: results,

            workers: null,
            factories: null,

            WORKER: &#x27;Worker&#x27;,
            FACTORY: &#x27;Factory&#x27;,


            /**
             * @method start
             */
            start: function () {

                if (this.isRunning) return;

                logger.log(&#x27;Computation&#x27;, &#x27;Starting&#x27;);

                createFactories()
                    .then(createWorkers)
                    .then(function () {

                        // Start the factories if disabled, won&#x27;t do anyhting
                        if (module.factories) module.factories.start();

                        // Start the workers, same as factories
                        if (module.workers) module.workers.start();

                        // Starting timers
                        countTimer = window.setInterval(counterCompleteHandler, project.computation.testIntervalTime);
                        resultCountTimer = window.setInterval(resultCounterCompleteHandler, project.computation.results.testIntervalTime);
                        jobCountTimer = window.setInterval(jobCounterCompleteHandler, project.computation.jobs.testIntervalTime);


                    });

                this.isRunning = true;
                this.isPaused = false;

            },
            /**
             * @method pause
             */
            pause: function () {
                logger.log(&#x27;Computation&#x27;, &#x27;Pause&#x27;);
                module.factories.pause();
                module.workers.pause();
                this.isPaused = true;
            },
            /**
             * @method resume
             */
            resume: function () {
                logger.log(&#x27;Computation&#x27;, &#x27;Resume&#x27;);
                module.factories.resume();
                module.workers.resume();
                this.isPaused = false;
            },
            /**
             * @method stop
             */
            stop: function () {

                if (!this.isRunning) return;

                logger.log(&#x27;Computation&#x27;, &#x27;Stopping&#x27;);

                module.stopWorkers();
                module.stopFactories();

                // Global timer
                window.clearInterval(countTimer);
                countTimer = null;


                this.isRunning = false;
            },

            /**
             * @method stopWorkers
             */
            stopWorkers: function () {
                if (module.workers) {
                    removeEventListenersFromPool(module.workers);
                    module.workers.stop();
                    module.workers = null;
                    window.clearInterval(resultCountTimer);
                    resultCountTimer = null;
                }
            },

            /**
             * @method stopFactories
             */
            stopFactories: function () {
                if (module.factories) {
                    removeEventListenersFromPool(module.factories);
                    module.factories.stop();
                    module.factories = null;
                    window.clearInterval(jobCountTimer);

                    jobCountTimer = null;
                }
            },

            /**
             * @method isComplete
             * @return {Promise}
             */
            isComplete: function () {
                var isComplete = true;

                return allFound(&#x27;results&#x27;, project.computation.results.expected)
                    .then(function (resultsComplete) {
                        isComplete = resultsComplete;
                        return allFound(&#x27;jobs&#x27;, project.computation.jobs.expected)
                    })
                    .then(function (jobsComplete) {
                        return isComplete = isComplete &amp;&amp; jobsComplete;
                    })

            },


            /**
             * @method pushJobToAwaitingWorker
             * @returns {Array}
             */
            pushJobToAwaitingWorker: function (job) {

                // Are there workers at all?
                if (!module.workers) return;

                var workers = module.workers.getIdleThreads();

                if (workers.length &gt; 0) {

                    // Need to publish lock?
                    if (project.computation.jobs.lock) {
                        jobs.lockJob(job).then(function () {
                            module.emit(&#x27;job:lock&#x27;, {uuid: job.uuid});
                            workers[0].pushJob(job);
                        });
                    }
                    // No need to lock
                    else {
                        workers[0].pushJob(job);
                    }

                }
            }

        });

    });
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
