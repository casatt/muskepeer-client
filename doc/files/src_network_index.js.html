<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src\network\index.js - muskepeer-client</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="muskepeer-client"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/Computation.html">Computation</a></li>
            
                <li><a href="../classes/Crypto.html">Crypto</a></li>
            
                <li><a href="../classes/Database.html">Database</a></li>
            
                <li><a href="../classes/FileSystem.html">FileSystem</a></li>
            
                <li><a href="../classes/GeoLocation.html">GeoLocation</a></li>
            
                <li><a href="../classes/Job.html">Job</a></li>
            
                <li><a href="../classes/Jobs.html">Jobs</a></li>
            
                <li><a href="../classes/Logger.html">Logger</a></li>
            
                <li><a href="../classes/MuskepeerClient.html">MuskepeerClient</a></li>
            
                <li><a href="../classes/MuskepeerModule.html">MuskepeerModule</a></li>
            
                <li><a href="../classes/Network.html">Network</a></li>
            
                <li><a href="../classes/Node.html">Node</a></li>
            
                <li><a href="../classes/Nodes.html">Nodes</a></li>
            
                <li><a href="../classes/Peer.html">Peer</a></li>
            
                <li><a href="../classes/Peers.html">Peers</a></li>
            
                <li><a href="../classes/Project.html">Project</a></li>
            
                <li><a href="../classes/Result.html">Result</a></li>
            
                <li><a href="../classes/Service.html">Service</a></li>
            
                <li><a href="../classes/Settings.html">Settings</a></li>
            
                <li><a href="../classes/Storage.html">Storage</a></li>
            
                <li><a href="../classes/Uuid.html">Uuid</a></li>
            
                <li><a href="../classes/Worker.html">Worker</a></li>
            
                <li><a href="../classes/Workers.html">Workers</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/Computation.html">Computation</a></li>
            
                <li><a href="../modules/Crypto.html">Crypto</a></li>
            
                <li><a href="../modules/Database.html">Database</a></li>
            
                <li><a href="../modules/FileSystem.html">FileSystem</a></li>
            
                <li><a href="../modules/GeoLocation.html">GeoLocation</a></li>
            
                <li><a href="../modules/Jobs.html">Jobs</a></li>
            
                <li><a href="../modules/Logger.html">Logger</a></li>
            
                <li><a href="../modules/MuskepeerClient.html">MuskepeerClient</a></li>
            
                <li><a href="../modules/Network.html">Network</a></li>
            
                <li><a href="../modules/Project.html">Project</a></li>
            
                <li><a href="../modules/Settings.html">Settings</a></li>
            
                <li><a href="../modules/Storage.html">Storage</a></li>
            
                <li><a href="../modules/Uuid.html">Uuid</a></li>
            
                <li><a href="../modules/Workers.html">Workers</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: src\network\index.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 *
 * @module Network
 * @class Network
 * @extends MuskepeerModule
 * @uses window
 *
 * @see http://www.html5rocks.com/en/mobile/workingoffthegrid/
 *
 */

define([&#x27;q&#x27;, &#x27;lodash&#x27;, &#x27;crypto/index&#x27;, &#x27;storage/index&#x27;, &#x27;project&#x27;, &#x27;settings&#x27;, &#x27;./geolocation&#x27;, &#x27;muskepeer-module&#x27;, &#x27;./collections/nodes&#x27;, &#x27;./collections/peers&#x27;, &#x27;uuid&#x27;, &#x27;./model/service&#x27;],


    function (Q, _, crypto, storage, project, settings, geolocation, MuskepeerModule, nodes, peers, uuid, Service) {


        var MASTER_BROADCAST_MESSAGE_TTL = 1000 * 60, //1m
            MASTER_BROADCAST_PEER_MAX_TIME_DRIFTING = 1000 * 60 * 2; //2m

        var module = new MuskepeerModule();

        // Detect network change
        window.addEventListener(&#x27;offline&#x27;, networkConnectivityStateChangeHandler);
        window.addEventListener(&#x27;online&#x27;, networkConnectivityStateChangeHandler);

        /**
         * Event-Handler, called when Network state changes
         *
         * @private
         * @method networkConnectivityStateChangeHandler
         * @param {Object} e
         */
        function networkConnectivityStateChangeHandler(e) {
            if (e.type === &#x27;online&#x27;) {
                logger.log(&#x27;Network&#x27;, &#x27;online!&#x27;);
            }
            else {
                logger.warn(&#x27;Network&#x27;, &#x27;offline!&#x27;);
            }
        }

        /**
         * @private
         * @method registerExternalServices
         */
        function registerExternalServices() {
            // Create external storage services
            project.network.services.forEach(function (settings, index) {
                if (!settings.enabled) return;
                settings.id = index + 1;
                module.services.push(new Service(settings));
            });

            logger.log(&#x27;Network&#x27;, &#x27;ExternalServices registered&#x27;);
        }


        /**
         * @private
         * @method masterMessageHandler
         */
        function masterMessageHandler(e) {
            if (isValidMasterMessage(e.data.message, e.data.signature)) {

                storage.db.has(&#x27;messages&#x27;, e.data.message.uuid)
                    .then(function (exists) {

                        if (!exists) {

                            // Inform
                            module.emit(e.type, e.data.message);

                            // Save
                            storage.db.save(&#x27;messages&#x27;, e.data.message)
                                .then(function () {
                                    // Broadcast
                                    peers.broadcast(e.type, e.data, e.target.uuid);
                                });

                        }
                    })
            }
        }


        /**
         * @private
         * @method isValidMasterMessage
         */
        function isValidMasterMessage(message, signature) {
            var now = Date.now();

            if (!message || !signature) return;

            // Signature is okay?
            if (!crypto.verify(JSON.stringify(message), signature)) {
                return false;
            }

            // We allow, some drifting, as time between clients might not be in sync
            if (!message.timestamp || message.timestamp &gt; now + MASTER_BROADCAST_PEER_MAX_TIME_DRIFTING) {
                return false;
            }

            // TTL reached?
            if (now &gt; message.timestamp + MASTER_BROADCAST_MESSAGE_TTL) {
                return false;
            }

            return true;
        }

        /**
         * Event-Handler, gets called when another Peer sends an offer
         * If the Peer is not yet in the Peers-Collection, it will be created and added.
         * Then the answering process gets initialized.
         *
         * @private
         * @method peerOfferHandler
         * @param {Object} data
         */
        function peerOfferHandler(data) {
            var peer = peers.getPeerByUuid(data.targetPeerUuid);

            if (!peer) {

                peers.update([
                    {
                        uuid: data.targetPeerUuid,
                        nodes: [data.nodeUuid],
                        location: data.location,
                        isSource: true,
                        isTarget: false
                    }
                ]);

                peer = peers.getPeerByUuid(data.targetPeerUuid);
            }

            peer.answerOffer(data);
        }

        /**
         * Event-Handler, gets called when another Peer sends an answer to an offer
         *
         * @private
         * @method peerAnswerHandler
         * @param {Object} data
         */
        function peerAnswerHandler(data) {
            var peer = peers.getPeerByUuid(data.targetPeerUuid);
            peer.acceptConnection(data);
        }

        /**
         * Event-Handler, gets called when another Peer sends candidate-data.
         * Adds the candidate-data to the Peer it came from
         *
         * @private
         * @method peerCandidateHandler
         * @param {Object} data
         */
        function peerCandidateHandler(data) {
            var peer = peers.getPeerByUuid(data.targetPeerUuid);
            peer.addCandidate(data);
        }


        /**
         * Event-Handler, gets called when a Peer-connection is completely established.
         *
         * @private
         * @method peerConnectedHandler
         * @param {Peer} peer
         */
        function peerConnectedHandler(peer) {
            peer.synchronize();
        }

        /**
         * Event-Handler, gets called when a Peer-connection is closed.
         * Causes a reconnect to nearest Peers if needed.
         *
         * @private
         * @method peerDisconnectHandler
         * @param {Object} e
         */
        function peerDisconnectHandler(e) {
            if (peers.getConnectedPeers().length &lt; settings.maxPeers) {
                peers.connectToNeighbourPeers();
            }
        }

        /**
         * Event-Handler, gets called when a Peer-connection
         * can&#x27;t be established after a specific time interval and a timeout occured.
         *
         * @private
         * @method peerTimeoutHandler
         * @param {Object} e
         */
        function peerTimeoutHandler(e) {
            peerDisconnectHandler(e);
        }


        /**
         * Event-Handler, gets called when a Peer receives a message.
         *
         * @param {Object} e
         */
        function peerMessageHandler(e) {
            var peer = e.target,
                externalList = e.list,
                uuid = e.uuid,
                list;

            logger.log(&#x27;Peer &#x27; + peer.id, &#x27;Received&#x27;, e.type);

            if (!e.type) {
                logger.log(&#x27;Network&#x27;, &#x27;peer:message without type received&#x27;);
                return;
            }
            switch (e.type.toLowerCase()) {

                case &#x27;node:list:pull&#x27; :
                    peer.sendNodeList(nodes.getNodeUuidsAsArray());
                    break;
                case &#x27;peer:list:pull&#x27; :
                    peer.sendPeerList(peers.getPeerUuidsAsArray());
                    break;
                case &#x27;file:list:pull&#x27; :
                    storage.getFileUuidsAsArray().then(function (list) {
                        peer.sendFileList(list);
                    });
                    break;
                case &#x27;job:list:pull&#x27; :
                    storage.getJobUuidsAsArray().then(function (list) {
                        peer.sendJobList(list);
                    });
                    break;
                case &#x27;result:list:pull&#x27; :
                    storage.getResultUuidsAsArray().then(function (list) {
                        peer.sendResultList(list);
                    });
                    break;
                case &#x27;node:list:push&#x27;:
                    list = nodes.getMissingNodeUuidsAsArray(externalList);
                    logger.log(&#x27;Peer &#x27; + peer.id, &#x27;Result of node:sync&#x27;, list.length);
                    peer.getNodeByUuid(list);
                    break;
                case &#x27;peer:list:push&#x27;:
                    list = peers.getMissingPeerUuidsAsArray(externalList);
                    logger.log(&#x27;Peer &#x27; + peer.id, &#x27;Result of peer:sync&#x27;, list.length);
                    peer.getPeerByUuid(list);
                    break;
                case &#x27;file:list:push&#x27;:
                    storage.getMissingFileUuidsAsArray(externalList).then(function (list) {
                        logger.log(&#x27;Peer &#x27; + peer.id, &#x27;Result of file:sync&#x27;, list.length);
                        peer.getFileByUuid(list);
                    });
                    break;
                case &#x27;job:list:push&#x27;:
                    storage.getMissingJobUuidsAsArray(externalList).then(function (list) {
                        logger.log(&#x27;Peer &#x27; + peer.id, &#x27;Result of job:sync&#x27;, list.length);
                        peer.getJobByUuid(list);
                    });
                    break;
                case &#x27;result:list:push&#x27;:
                    storage.getMissingResultUuidsAsArray(externalList).then(function (list) {
                        logger.log(&#x27;Peer &#x27; + peer.id, &#x27;Result of result:sync&#x27;, list.length);
                        peer.getResultByUuid(list);
                    });
                    break;

                case &#x27;node:pull&#x27;:
                    peer.sendPeer(nodes.getNodeByUuid(uuid).serialize());
                    break;
                case &#x27;peer:pull&#x27;:
                    peer.sendPeer(peers.getPeerByUuid(uuid).serialize());
                    break;
                case &#x27;file:pull&#x27;:
                    break;
                case &#x27;job:pull&#x27;:
                    storage.db.read(&#x27;jobs&#x27;, uuid, {uuidIsHash: true}).then(function (job) {
                        peer.sendJob(job);
                    });
                    break;
                case &#x27;result:pull&#x27;:
                    storage.db.read(&#x27;results&#x27;, uuid, {uuidIsHash: true}).then(function (result) {
                        if (result) peer.sendResult(result);
                    });
                    break;

                case &#x27;node:push&#x27;:
                    nodes.update(e.node);
                    break;
                case &#x27;peer:push&#x27;:
                    peers.update(e.peer);
                    break;
                case &#x27;file:push&#x27;:
                    break;
                case &#x27;job:push&#x27;:
                    storage.db.save(&#x27;jobs&#x27;, e.job, {uuidIsHash: true});
                    break;
                case &#x27;result:push&#x27;:
                    storage.db.save(&#x27;results&#x27;, e.result, {uuidIsHash: true});
                    break;

                case &#x27;broadcast:job&#x27;:
                    break;
                case &#x27;broadcast:result:push&#x27;:

                    // Do i already know about this?
                    storage.db.has(&#x27;results&#x27;, e.data.uuid)
                        .then(function (exists) {

                            if (!exists) {
                                // Rebroadcast
                                peers.broadcast(&#x27;result&#x27;, e.data, peer.uuid);

                                // Store the result
                                return storage.db.save(&#x27;results&#x27;, e.data, {uuidIsHash: true})
                                    .then(function () {
                                        module.emit(&#x27;result:push&#x27;);
                                    });

                            }
                            else return Q();

                        });


                    break;
                case &#x27;broadcast:peer&#x27;:
                    break;
                case &#x27;broadcast:file&#x27;:
                    break;
                case &#x27;broadcast:computation:start&#x27;:
                    masterMessageHandler(e);
                    break;
                case &#x27;broadcast:computation:stop&#x27;:
                    masterMessageHandler(e);
                    break;
            }
        }


        return module.extend({

            /**
             * Determine if the client is on-/offline
             * @property isOnline {Boolean}
             */
            isOnline: window.navigator.onLine,

            nodes: nodes,
            peers: peers,

            services: [],

            /**
             * Start the network-module
             *
             * @method start
             */
            start: function () {

                // No need to do anything more if we are not online
                if (!module.isOnline) {
                    logger.warn(&#x27;Network&#x27;, &#x27;not starting, no internet-connection.&#x27;);
                    return;
                }

                // Adding listeners to nodes collection
                nodes.on(&#x27;peer:offer&#x27;, peerOfferHandler);
                nodes.on(&#x27;peer:answer&#x27;, peerAnswerHandler);
                nodes.on(&#x27;peer:candidate&#x27;, peerCandidateHandler);

                // Adding listeners to peers collection
                peers.on(&#x27;peer:connect&#x27;, peerConnectedHandler);
                peers.on(&#x27;peer:message&#x27;, peerMessageHandler);
                peers.on(&#x27;peer:disconnect&#x27;, peerDisconnectHandler);
                peers.on(&#x27;peer:timeout&#x27;, peerTimeoutHandler);


                registerExternalServices();


                // Detect geoLocation
                geolocation.getGeoLocation()
                    .then(function (location) {
                        logger.log(&#x27;Geolocation&#x27;, &#x27;Location available&#x27;);
                        // Get nodes from database
                        return storage.db.findAndReduceByObject(&#x27;nodes&#x27;, {filterDuplicates: false}, {projectUuid: project.uuid})
                    })
                    .then(function (nodeData) {
                        // Create instances of type model/node
                        nodes.update(nodeData);
                    })
                    .then(nodes.connect)
                    .then(nodes.authenticate)
                    .then(nodes.getRelatedPeers)
                    .then(function (peerData) {
                        // Create instances of type model/peer
                        peers.update(peerData);
                    })
                    .then(peers.connectToNeighbourPeers)
                    .done(function () {
                        logger.log(&#x27;Network&#x27;, &#x27;Start complete&#x27;);
                    });

            },
            /**
             * Stop the network module
             *
             * @method stop
             */
            stop: function () {
                //TODO deconstruct, remove listeners, close all connections
            },


            /**
             *@method publish
             */
            publish: function (type, data) {

                // Broadcast to peers
                peers.broadcast(type, data);

                // Broadcast to services
                module.services.forEach(function (service) {
                    service.save(data);
                });
            },


            /**
             * @method broadcastMasterMessage
             * @param type
             * @param data
             */
            broadcastMasterMessage: function (type, data) {

                data = data || {};

                var msg = _.extend(data, {
                        uuid: uuid.generate(),
                        type: type,
                        timestamp: Date.now()
                    }),
                    signature = crypto.sign(JSON.stringify(msg));

                peers.broadcast(type, {
                        &#x27;message&#x27;: msg,
                        &#x27;signature&#x27;: signature
                    }
                );

            }
        });
    }
);


    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
